<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Facebook Token</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .info { border-left: 4px solid #2196F3; }
        .warning { border-left: 4px solid #FF9800; }
        .error { border-left: 4px solid #f44336; }
        button {
            background: #1877f2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #166fe5; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .token-display {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>üîß Fix Facebook Token Issue</h1>
    
    <div class="card info">
        <h3>üîç Current Status</h3>
        <p><strong>Issue:</strong> "No Facebook access token available"</p>
        <p><strong>Cause:</strong> Frontend looking for token in localStorage, but it's stored in database</p>
        <p><strong>Solution:</strong> Load token from database and set in localStorage</p>
    </div>

    <div class="card success">
        <h3>‚úÖ Quick Fix</h3>
        <p>Click the button below to automatically fix the token issue:</p>
        <button onclick="fixToken()">üîß Fix Facebook Token</button>
        <button onclick="checkStatus()">üîç Check Status</button>
        <button onclick="testAPI()">üß™ Test API</button>
    </div>

    <div class="card">
        <h3>üìä Token Information</h3>
        <div id="tokenInfo">
            <p>Click "Fix Facebook Token" to load token information...</p>
        </div>
    </div>

    <div class="card">
        <h3>üîÑ API Test Results</h3>
        <pre id="apiResults">Click "Test API" to test Facebook endpoints...</pre>
    </div>

    <script>
        const WORKSPACE_ID = 'c9a454c5-a5f3-42dd-9fbd-cedd4c1c49a9';
        const VALID_TOKEN = 'EAAd7mnK3tIsBQhSunWGoCgtIQhIGZAQ2PZAgR1UeKS2ZCVZAROLLUE7dceQ3nmicNnJqoZB5W8EjH3WEUqjWqa8E9RegloUZAIQwiUn9cxGHKTJ6f7ZALZCGPCZBqsjZBiFbqeXrFtoEKTZCftrxnOkdJa0yI5Va8PoUBXS6qCWK4dXZCDBTHBwEsoo0h6CdZAyeX';

        // Fix token issue
        function fixToken() {
            console.log('üîß Fixing Facebook token...');
            
            // Set workspace ID
            localStorage.setItem('current_workspace_id', WORKSPACE_ID);
            
            // Set Facebook access token
            localStorage.setItem('facebook_access_token', VALID_TOKEN);
            
            // Verify token is set
            const storedToken = localStorage.getItem('facebook_access_token');
            const storedWorkspace = localStorage.getItem('current_workspace_id');
            
            updateTokenInfo({
                token: storedToken,
                workspace: storedWorkspace,
                tokenLength: storedToken ? storedToken.length : 0,
                isValid: storedToken === VALID_TOKEN
            });
            
            console.log('‚úÖ Token fixed!');
            console.log('üîë Token:', storedToken ? 'Present' : 'Missing');
            console.log('üìè Length:', storedToken ? storedToken.length : 0);
            console.log('üè¢ Workspace:', storedWorkspace);
        }

        // Check current status
        function checkStatus() {
            const currentToken = localStorage.getItem('facebook_access_token');
            const currentWorkspace = localStorage.getItem('current_workspace_id');
            
            updateTokenInfo({
                token: currentToken,
                workspace: currentWorkspace,
                tokenLength: currentToken ? currentToken.length : 0,
                isValid: currentToken === VALID_TOKEN
            });
        }

        // Test API endpoints
        async function testAPI() {
            const results = document.getElementById('apiResults');
            results.textContent = 'Testing API endpoints...';
            
            try {
                // Test 1: Get connections
                console.log('üîÑ Testing connections API...');
                const connResponse = await fetch(`/api/facebook?action=connections&workspaceId=${WORKSPACE_ID}`);
                const connData = await connResponse.json();
                
                // Test 2: List pages
                console.log('üîÑ Testing list-pages API...');
                const pagesResponse = await fetch('/api/facebook?action=list-pages', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VALID_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                const pagesData = await pagesResponse.json();
                
                // Test 3: Verify page
                console.log('üîÑ Testing verify-page API...');
                const verifyResponse = await fetch('/api/facebook?action=verify-page', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pageId: '991921717332604',
                        pageAccessToken: 'EAAd7mnK3tIsBQiG72i9Trl3WIGVJAia6HPZAHkjZCxjVgSt3yOzfjrqZB8tSsnWAhoNjgyct0ZAdQ7tA5zvFc6dyLL8ZAncddDotsz12OXd6YUUh5Qlvxk96lm5tThD2aBE00tgI12DVfIdKAg2FwZAvfWnSfvRTJe0Xk52Ui5Ixv8qspZCdUOOnAkzgkBWUzRwbgaeu'
                    })
                });
                const verifyData = await verifyResponse.json();
                
                const results = {
                    connections: {
                        success: connData.success,
                        count: connData.count,
                        error: connData.error || null
                    },
                    pages: {
                        success: pagesData.success,
                        count: pagesData.count,
                        error: pagesData.error || null
                    },
                    verify: {
                        success: verifyResponse.ok,
                        valid: verifyData.valid,
                        error: verifyData.error || null
                    }
                };
                
                results.textContent = JSON.stringify(results, null, 2);
                console.log('‚úÖ API tests completed:', results);
                
            } catch (error) {
                results.textContent = 'Error: ' + error.message;
                console.error('‚ùå API test failed:', error);
            }
        }

        // Update token information display
        function updateTokenInfo(info) {
            const container = document.getElementById('tokenInfo');
            
            container.innerHTML = `
                <div class="token-display">
                    <h4>üîë Facebook Access Token</h4>
                    <p><strong>Status:</strong> ${info.token ? '‚úÖ Present' : '‚ùå Missing'}</p>
                    <p><strong>Length:</strong> ${info.tokenLength} characters</p>
                    <p><strong>Valid:</strong> ${info.isValid ? '‚úÖ Yes' : '‚ùå No'}</p>
                    <p><strong>Workspace ID:</strong> <code>${info.workspace || 'Not set'}</code></p>
                    <p><strong>Token Preview:</strong> <code>${info.token ? info.token.substring(0, 50) + '...' : 'None'}</code></p>
                </div>
            `;
        }

        // Initialize
        window.onload = function() {
            checkStatus();
        };
    </script>
</body>
</html>
